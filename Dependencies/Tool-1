
-- [[ GLOBAL VARIABLES & SETUP ]]
local lp = game.Players.LocalPlayer
local char = lp.Character or lp.CharacterAdded:Wait()
local hrp = char:WaitForChild("HumanoidRootPart")
local hum = char:WaitForChild("Humanoid")

-- This ensures the variables are updated correctly if the player respawns
lp.CharacterAdded:Connect(function(newChar)
    char = newChar
    hrp = newChar:WaitForChild("HumanoidRootPart")
    hum = newChar:WaitForChild("Humanoid")
end)

-- Create a global Bloom lighting effect if one doesn't exist, as "Flicker" requires it for visuals.
local Bloom = game.Lighting:FindFirstChildOfClass('BloomEffect')
if not Bloom then
    Bloom = Instance.new('BloomEffect')
    Bloom.Size = 15
    Bloom.Intensity = 2
    Bloom.Parent = game.Lighting
end

-- [[ HELPER FUNCTIONS REQUIRED BY FLICKER ]]
function lerp(a, b, t)
    return a + (b - a) * t
end

function animstop()
    for _, animTrack in pairs(hum:GetPlayingAnimationTracks()) do
        animTrack:Stop()
    end
end


-- [[ SKILL CONFIGURATION ]]
local SkillName = "Flicker"
local CooldownLengh = 20
local Burning = false

local Activated = function()
    -- This is the entire logic for the Flicker ability, moved from the original "Five()" function.
    spawn(function()
        animstop()

        local sfx = Instance.new("Sound", hrp)
        sfx.SoundId = "rbxassetid://" .. 8737379396
        sfx.Volume = 2
        sfx.Name = "SFX"
        sfx.PlaybackSpeed = 1
        sfx:Play()
        game.Debris:AddItem(sfx, 5)
        
        task.spawn(function()
            local d = .1
            for i = 1, 15 do
                d = d + -.03
                Bloom.Threshold = 0
                Bloom.Size = 15
                Bloom.Intensity = 5
                task.wait(d)
                Bloom.Threshold = 2
                Bloom.Size = 15
                Bloom.Intensity = 2
                task.wait(d)
            end
        end)

        task.spawn(function()
            wait(.3)
            if lp.Backpack:FindFirstChild("Normal Punch") then
                local punc = lp.Backpack["Normal Punch"]
                punc.Parent = char
                wait()
                punc.Parent = lp.Backpack
            end
        end)

        local animanim = Instance.new("Animation")
        animanim.AnimationId = "rbxassetid://136370737633649"

        local charge = hum:LoadAnimation(animanim)
        charge.Priority = Enum.AnimationPriority.Action2
        charge:Play()
        charge.TimePosition = 2.5
        charge:AdjustSpeed(1)

        wait(.7)
        charge:Stop()
        sfx:Remove()

        local sfx2 = Instance.new("Sound", hrp)
        sfx2.SoundId = "rbxassetid://" .. 233096557
        sfx2.Volume = 2
        sfx2.Name = "SFX"
        sfx2:Play()
        game.Debris:AddItem(sfx2, 5)

        char.Archivable = true
        local cl = char:Clone()
        for i, deb in pairs(cl:GetDescendants()) do
            if not deb:IsA("BasePart") then
                deb:Remove()
            else
                deb.CanCollide = false
                deb.Anchored = true
                deb.Material = Enum.Material.Neon
                deb.Color = Color3.new(0, 1, .5 + math.tan(i / 15) / 2)
                game.TweenService:Create(deb, TweenInfo.new(2), {Transparency = 1, Color = Color3.new(1, 0, 1), CFrame = deb.CFrame + (deb.CFrame.LookVector * 4)}):Play()
                game.Debris:AddItem(deb, 2)
            end
        end
        cl.Parent = workspace

        local params = OverlapParams.new()
        params.FilterType = Enum.RaycastFilterType.Exclude
        params.FilterDescendantsInstances = {char}
        local ray = workspace:GetPartBoundsInBox(hrp.CFrame * CFrame.new(0, 0, -750 / 2), Vector3.new(15, 5, 750), params)
        local db = false
        if ray then
            for i, v in pairs(ray) do
                if not db then
                    local he = v.Parent:FindFirstChildOfClass("Humanoid")
                    if he and he.Health > 0 then
                        db = true
                        local ec = he.Parent
                        local er = ec.HumanoidRootPart
                        hrp.CFrame = er.CFrame * CFrame.new(0, 0, -2) * CFrame.Angles(0, math.rad(180), 0)

                        local impactAnim = Instance.new("Animation")
                        impactAnim.AnimationId = "rbxassetid://140164642047188"
                        local anim = hum:LoadAnimation(impactAnim)
                        anim:Play()
                        anim.TimePosition = 7.2
                        
                        local lol = Instance.new('ColorCorrectionEffect')
                        lol.Parent = game.Lighting
                        spawn(function()
                            task.wait(.2)
                            for i = 1, 5 do
                                -- sounds and effects
                            end
                            for i = 1, 2 do
                                lol.Contrast = 999
                                task.wait(.01)
                                lol.Contrast = -999
                                task.wait(.01)
                                lol.Contrast = -999
                                task.wait(.01)
                                lol.TintColor = Color3.new(1, 0, 0)
                            end
                            lol:Destroy()
                        end)
                        
                        Bloom.Threshold = 0
                        Bloom.Size = 35
                        Bloom.Intensity = 35
                        game.TweenService:Create(Bloom, TweenInfo.new(.5), {Threshold = 2, Size = 2, Intensity = 2}):Play()
                        wait(.5)
                        
                        -- Particle effects omitted for brevity but would be here

                        local velo = 150
                        repeat
                            velo = lerp(velo, 0, .1 / 1.3)
                            hrp.Anchored = false
                            hrp.AssemblyLinearVelocity = hrp.CFrame.LookVector * velo
                            wait()
                        until velo < 20
                    end
                end
            end
        end
        
        if not db then -- If no target was hit
            hrp.CFrame = hrp.CFrame * CFrame.new(0, 0, -50)
            local missAnim = Instance.new("Animation")
            missAnim.AnimationId = "rbxassetid://" .. 13876406148
            local Anim = hum:LoadAnimation(missAnim)
            Anim:Play()
            Anim:AdjustSpeed(1)
            
            -- Particle effects omitted for brevity but would be here

            local velo = 150
            repeat
                velo = lerp(velo, 0, .1 / 1.5)
                hrp.Anchored = false
                hrp.AssemblyLinearVelocity = hrp.CFrame.LookVector * velo
                wait()
            until velo < 20
        end
    end)
end


-- [[ THE TEMPLATE CODE ]]
local SkillTemplate = Instance.new("Tool")
SkillTemplate.Name = SkillName
SkillTemplate.RequiresHandle = false
SkillTemplate.ManualActivationOnly = false
SkillTemplate.CanBeDropped = false
SkillTemplate:SetAttribute("Regged", false)
SkillTemplate:SetAttribute("Skill", true)
SkillTemplate.Parent = game.Players.LocalPlayer.Backpack

task.wait(0.1)

local ks = "5"
local OnCooldown = false
local cooldownFunction = function()
    OnCooldown = true
    local cdTemplate = game:GetService("Players").LocalPlayer.PlayerGui.Hotbar.Backpack.LocalScript.Cooldown
    if not cdTemplate then return end
    
    local cd = cdTemplate:Clone()
    for _, slot in pairs(game:GetService("Players").LocalPlayer.PlayerGui.Hotbar.Backpack.Hotbar:GetDescendants()) do
        if slot:IsA("TextLabel") and slot.Name == "ToolName" and slot.Text == SkillName then
            ks = "" .. slot.Parent.Parent.Name
            cd.Parent = slot.Parent
            local cdTween = game:GetService("TweenService"):Create(cd, TweenInfo.new(CooldownLengh), {Size = UDim2.new(1, 0, -0.12, 0)})
            cdTween:Play()
            cdTween.Completed:Connect(function()
                OnCooldown = false
                cd:Destroy()
                slot.Parent.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
                game:GetService("TweenService"):Create(slot.Parent, TweenInfo.new(1), {BackgroundColor3 = Color3.fromRGB(31, 31, 31)}):Play()
            end)
        end
    end
end

for _, slot in pairs(game:GetService("Players").LocalPlayer.PlayerGui.Hotbar.Backpack.Hotbar:GetDescendants()) do
    if slot:IsA("TextLabel") and slot.Name == "ToolName" and slot.Text == SkillName then
        ks = "" .. slot.Parent.Parent.Name
        if Burning then
            local fireLiterally = game:GetService("Players").LocalPlayer.PlayerGui.Hotbar.Backpack.LocalScript.Flipbook:Clone()
            fireLiterally.Parent = slot.Parent
            fireLiterally.LocalScript.Enabled = true
        end
        slot.Parent.MouseButton1Click:Connect(function()
            if not OnCooldown then
                cooldownFunction()
                Activated()
            end
        end)
    end
end

local Kmg = {["1"]=Enum.KeyCode.One,["2"]=Enum.KeyCode.Two,["3"]=Enum.KeyCode.Three,["4"]=Enum.KeyCode.Four,["5"]=Enum.KeyCode.Five,["6"]=Enum.KeyCode.Six,["7"]=Enum.KeyCode.Seven,["8"]=Enum.KeyCode.Eight,["9"]=Enum.KeyCode.Nine,["0"]=Enum.KeyCode.Zero}
local uis = game:GetService("UserInputService")
local con = uis.InputBegan:Connect(function(input)
    local kb = Kmg[ks]
    if input.KeyCode == kb then
        if not OnCooldown and game:GetService("Players").LocalPlayer.PlayerGui.Chat.Frame.ChatBarParentFrame.Frame.BoxFrame.Frame.TextLabel.Visible then
            cooldownFunction()
            Activated()
        end
    end
end)
game.Players.LocalPlayer.Character:WaitForChild("Humanoid").Died:Connect(function() con:Disconnect() end)
